--
tasks:
  - name: Install the latest version of sshd
    package:
      name: sshd
      state: latest

  - name: Enable sshd
    service:
      name: sshd
      enabled: yes
      state: started

  - name: Create user
    user:
      name: "{{ ansible_user }}"
      groups: wheel

  - name: Set authorized key
    authorized_key:
      user: "{{ ansible_user }}"
      state: present
      key: "{{ ssh_key_location }}"

  - name: Disallow password authentication for ssh
    lineinfile: dest=/etc/ssh/sshd_config
                regexp="^PasswordAuthentication"
                line="PasswordAuthentication no"
                state=present
    notify: Restart sshd

  - name: Disallow root ssh access
    lineinfile: dest=/etc/ssh/sshd_config
                regexp="^PermitRootLogin"
                line="PermitRootLogin no"
                state=present
    notify: Restart sshd

  - name: Install the latest version of Avahi
    package:
      name: avahi
      state: latest

  - name: Enable and Start Avahi
    service:
      name: avahi
      enabled: yes
      state: started

handlers:
  - name: Restart sshd
    service:
      name: sshd
      state: restarted
---

- hosts: all
  tasks:
  - include_vars: secrets.yml

  - name: Install Ansible dependancies
    package:
      name: "{{ item }}"
      state: latest
    with_items:
      - libselinux-python
      - python-firewall
    become: true

  - name: Install the latest version of openssh
    package:
      name: openssh
      state: latest
    become: true

  - name: Enable sshd
    service:
      name: sshd
      enabled: yes
      state: started
    become: true

  - name: Create user {{ ansible_ssh_user }}
    user:
      name: "{{ ansible_ssh_user }}"
      groups: wheel
      append: yes
    become: true

  - name: Allow 'wheel' group to have passwordless sudo
    lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^%wheel'
      line: '%wheel ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'
    become: true

  - name: Set authorized key
    authorized_key:
      user: "{{ ansible_ssh_user }}"
      state: present
      key: "{{ ssh_key_location }}"

  - name: Disallow password authentication for ssh
    lineinfile: dest=/etc/ssh/sshd_config
                regexp="^PasswordAuthentication"
                line="PasswordAuthentication no"
                state=present
    become: true
    notify: Restart sshd

  - name: Disallow root ssh access
    lineinfile: dest=/etc/ssh/sshd_config
                regexp="^PermitRootLogin"
                line="PermitRootLogin no"
                state=present
    become: true
    notify: Restart sshd

  - name: Install mDNS software
    package:
      name: "{{ item }}"
      state: latest
    with_items:
      - avahi
      - nss-mdns
    become: true
    notify: Restart Avahi

  - name: Open firewall port for mDNS
    firewalld:
      service: mdns
      permanent: true
      immediate: true
      state: enabled
    become: true

  - name: Enable and Start Avahi
    service:
      name: avahi-daemon
      enabled: yes
      state: started
    become: true

  handlers:
    - name: Restart sshd
      service:
        name: sshd
        state: restarted
      become: true

    - name: Restart Avahi
      service:
        name: avahi-daemon
        state: restarted
      become: true